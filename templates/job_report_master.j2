<html>
<head>
  <!-- Viewport options can make the page scale better on mobile -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
  <!-- CSS styling for our HTML report -->
  {% include './stylesheet.css.j2' %}
  </style>

</head>

<body>

  <!-- This is our left-hand menu and navigation bar.
  We will generate links for each host, breaking them up by job status. -->

  <div class="sidenav">
    <p><a style="text-align:center;font-weight:bold" href="#summary">Summary</a></p>
    <p>Host Status</p>
    {% for item in ansible_play_hosts_all | sort %}
    <a {% if not hostvars[item]['job_success']|bool %}style="color:red"{% endif %} href="#{{ item }}">{{ item }}</a>
    {% endfor %}
    <p>Missing Hosts</p>
    {% for item in ansible_play_hosts_all | sort %}{% if hostvars[item]['missing']|bool %}
    <a href="#{{ item }}">{{ item }}</a>
    {% endif %}{% endfor %}
    <p>Failed Hosts</p>
    {% for item in ansible_play_hosts_all | sort %}{% if (not hostvars[item]['job_success']|bool) and (not hostvars[item]['missing']|bool) %}
    <a href="#{{ item }}">{{ item }}</a>
    {% endif %}{% endfor %}
  </div>

  <div class="content">

    <h1>Job Status Report</h1>
    <p><i>Generated {{ hostvars['localhost']['date_str_pretty'] }} from templates/job_report_master.j2</i></p>
    <hr>

    <table style="width:75%;text-align:left;background: #f9f9f9 none repeat scroll 0 0;">
    <tr><th>A Simple Table of Contents:</th></tr>
    <tr><td>{% for item in ansible_play_hosts_all | sort %}<a href="#{{ item }}">{{ item }}</a>  {% endfor %}</td></tr>
    </table>
    
    <h1 id="summary">Summary</h2>

    <p><strong>Kernel Versions in Environment:</strong></p>
    <table style="width:auto;text-align:left;background: #f9f9f9 none repeat scroll 0 0;">
      {% for item in hostvars['localhost']['kernels_list'] %}
      <tr><th>Kernel {{ item }}</th></tr>
      <tr><td>{{ hostvars | dict2items | json_query('[?value.ansible_kernel==`' + item + '`].key') | join(' ') | default('NO KERNELS FOUND')}}</td></tr>
      {% endfor %}
    </table>

    <!-- Now we loop through the hosts in our play, and generate per-host report fragments.
    Each fragment will have a header that aligns with the "table of contents" links above.
    Note that we use 'thehost' as our loop variable. -->
    {% for thehost in ansible_play_hosts_all | sort %}
      {% include './job_report_host.j2' %}
    {% endfor %}
    
    <hr>
    <p><i>Generated by Ansible playbook <strong>{{ playbook_dir }}/job_report.yaml</strong><br>
    These reports can also be found in the Ansible host's <strong>{{ playbook_dir }}/reports/</strong> folder.</i></p>
  
  </div>


</body>

</html>